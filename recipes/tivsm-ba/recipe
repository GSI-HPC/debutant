# -*- sh -*-

ARCHIVE=$1

if [ -z $ARCHIVE ]; then
   ARCHIVE=`fetch ftp://public.dhe.ibm.com/storage/tivoli-storage-management/maintenance/client/v6r4/Linux/LinuxX86/BA/v643/6.4.3.0-TIV-TSMBAC-LinuxX86.tar`
fi

VERSION=`echo $ARCHIVE | sed -ne "s/^\(\([0-9]\.\)\{2\}[0-9]\+\).*/\1/p"`

tar -xvf $ARCHIVE -C $BUILD_DIR

### gskcrypt64

extract $BUILD_DIR/gskcrypt64-8.0.*.linux.x86_64.rpm
PKG_DIR=$BUILD_DIR/gskcrypt64-8.0
PACKAGE=gskcrypt64
disable_install_scripts
add_debian_files
debian_control Section non-free/libs
# package version is something like 8.0-15.26
build_package --keep-revision
drop_result

### gskssl64

extract $BUILD_DIR/gskssl64-8.0.*.linux.x86_64.rpm
PKG_DIR=$BUILD_DIR/gskssl64-8.0
PACKAGE=gskssl64
disable_install_scripts
add_debian_files
debian_control Section non-free/libs
# see above
build_package --keep-revision
drop_result

### TSM API

extract $BUILD_DIR/TIVsm-API64.x86_64.rpm

PKG_DIR=$BUILD_DIR/TIVsm-API64-${VERSION}

PACKAGE=tivsm-api

disable_install_scripts

add_debian_files
debian_control Maintainer "$DEBFULLNAME <$DEBEMAIL>"


# TODO: /usr/share/locale/en/ does not look like the right location
if [ -e $PKG_DIR/opt/tivoli/tsm/client/lang/EN_US/dsmclientV3.cat ]; then
    # v6:
    debian_install opt/tivoli/tsm/client/lang/EN_US/dsmclientV3.cat usr/share/locale/en/
elif [ -e $PKG_DIR/opt/tivoli/tsm/client/api/bin64/EN_US/dsmclientV3.cat ]; then
    # v7:
    debian_install opt/tivoli/tsm/client/api/bin64/EN_US/dsmclientV3.cat usr/share/locale/en/
fi

# v6:
if [ -d $PKG_DIR/opt/tivoli/tsm/client/lang ]; then
    debian_install opt/tivoli/tsm/client/lang usr/share/tsm
fi

# v7:
ls -d1 $PKG_DIR/opt/tivoli/tsm/client/api/bin64/[A-Z][A-Z]_[A-Z][A-Z] |
    sed -e "s|$PKG_DIR/||" |
    while read DIR; do
        debian_install $DIR usr/share/tsm/lang
    done

build_package

drop_result


### TSM BA

extract $BUILD_DIR/TIVsm-BA.x86_64.rpm

PKG_DIR=$BUILD_DIR/TIVsm-BA-${VERSION}
PACKAGE=tivsm-ba

disable_install_scripts

add_debian_files

add_dependency tivsm-api

# needs ksh compatible interpreter:
add_dependency "ksh | mksh | pdksh | zsh"

debian_control Section non-free/admin
debian_control Replaces tsm-ba

if [ ! -e $PKG_DIR/opt/tivoli/tsm/client/ba/bin/EN_US ]; then
    debian_links usr/share/tsm/lang/EN_US usr/lib/tsm/ba/bin/EN_US
fi

build_package

drop_result
